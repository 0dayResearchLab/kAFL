- name: Install build dependencies
  apt:
    name: "{{ item }}"
  become: yes
  with_items:
    - pkg-config
    - libglib2.0-dev
    - libpixman-1-dev

- name: Install build dependencies for virtfs
  package:
    name: "{{ item }}"
    state: present
  become: yes
  with_items:
    - libcap-dev
    - libattr1-dev

- name: Clone repo
  git:
    repo: "{{ repo.qemu.url }}"
    dest: "{{ repo.qemu.root }}"
    version: "{{ repo.qemu.revision | default(omit) }}"
    force: yes

- name: Configure QEMU
  command:
    argv:
      - ./configure
      - --target-list=x86_64-softmmu
      - --disable-gtk
      - --disable-docs
      - --disable-werror
      - --disable-capstone
      - --disable-libssh
      - --enable-virtfs
      - --enable-nyx
      - --enable-nyx-static
      - --disable-tools
    chdir: "{{ repo.qemu.root }}"
  # TODO: duplicated env
  environment:
    C_INCLUDE_PATH: "{{ repo.capstone.root }}/include:{{ repo.libxdc.root }}"
    LIBRARY_PATH: "{{ repo.capstone.root }}:{{ repo.libxdc.root }}/"
    LD_LIBRARY_PATH: "{{ repo.capstone.root }}:{{ repo.libxdc.root }}/"

- name: Build QEMU
  make:
    chdir: "{{ repo.qemu.root }}"
    params:
      --jobs: "{{ ansible_processor_nproc }}"
  environment:
    C_INCLUDE_PATH: "{{ repo.capstone.root }}/include:{{ repo.libxdc.root }}"
    LIBRARY_PATH: "{{ repo.capstone.root }}:{{ repo.libxdc.root }}/"
    LD_LIBRARY_PATH: "{{ repo.capstone.root }}:{{ repo.libxdc.root }}/"
